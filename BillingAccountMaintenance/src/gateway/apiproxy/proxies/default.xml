<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ProxyEndpoint name="default">
    <Description/>
    <FaultRules>
        <FaultRule name="Generic Fault">
            <Condition>(response.status.code equals 500) or (jsontoxml.failed equals 'true') or (jsonattack.failed equals 'true')</Condition>
            <Step>
                <Name>AssignMessageGenericFault</Name>
            </Step>
        </FaultRule>
        <FaultRule name="Resource Not Found">
            <Condition>(error.status.code = 404 || raisefault.RaiseFaultResourceNotFound.failed = true)</Condition>
            <Step>
                <Name>AssignMessageResourceNotFound</Name>
            </Step>
        </FaultRule>
        <FaultRule name="Spike Arrest Errors">
            <Condition>ratelimit.SpikeArrest.failed=true</Condition>
            <Step>
                <Name>AssignMessageSpikeArrestFault</Name>
            </Step>
        </FaultRule>
        <FaultRule name="OAuthFault">
            <Condition>(oauthV2.OAuth-v20.failed = true)</Condition>
            <Step>
                <Name>AssignMessageInvalidAccessToken</Name>
                <Condition>(fault.name = "invalid_access_token") or (fault.name="InvalidAccessToken") or (fault.name = "access_token_expired")</Condition>
            </Step>
            <Step>
                <Name>AssignMessageInsufficientScope</Name>
                <Condition>(fault.name="InsufficientScope")</Condition>
            </Step>
            <Step>
                <Name>AssignMessageGenericOauthError</Name>
                <Condition>(fault.name != "invalid_access_token") and (fault.name != "InvalidAccessToken") and (fault.name != "access_token_expired") and (fault.name != "InsufficientScope")</Condition>
            </Step>
        </FaultRule>
        <FaultRule name="API Key Fault">
            <Condition>(verifyapikey.VerifyAPIKey.failed = true) or (response.status.code equals 403) or (response.status.code equals 401)</Condition>
            <Step>
                <Name>AssignMessageAPIKeyFault</Name>
            </Step>
        </FaultRule>
    </FaultRules>
    <DefaultFaultRule>
        <AlwaysEnforce>true</AlwaysEnforce>
        <Step>
            <Name>JavaScriptCatchJSErrors</Name>
        </Step>
        <Step>
            <Name>AssignMessageGenerateFaultResponse</Name>
        </Step>
        <Step>
            <Name>ServiceCalloutLogError</Name>
        </Step>
        <Step>
            <Name>add-cors</Name>
        </Step>
    </DefaultFaultRule>
    <PreFlow name="PreFlow">
        <Request>
            #GlobalGuid#
            <Step>
                <Name>Verify-API-Key-1</Name>
            </Step>
            <Step>
                <Name>JavaScriptValidateRequestHeader</Name>
            </Step>
            <Step>
                <Name>OAuth-v20</Name>
            </Step>
            <Step>
                <Name>ExtractAccountNumber</Name>
            </Step>
            <Step>
                <Name>KVM-GetValidLDAPGroups</Name>
            </Step>
            <Step>
                <Name>JavaScriptFineGrainedAuthorization</Name>
            </Step>
            <Step>
                <Name>SpikeArrest</Name>
            </Step>
            <Step>
                <Name>ServiceCalloutLogRequest</Name>
            </Step>
            <Step>
                <Name>remove-header-authorization</Name>
            </Step>
        </Request>
        <Response/>
    </PreFlow>
    <PostFlow name="PostFlow">
        <Request/>
        <Response>
            <Step>
                <Name>ServiceCalloutLogResponse</Name>
                <Condition>(request.verb IsNot "OPTIONS")</Condition>
            </Step>
            <Step>
                <Name>add-cors</Name>
            </Step>
        </Response>
    </PostFlow>
    <Flows>
        <Flow name="OptionsPreFlight">
            <Condition>request.verb == "OPTIONS"</Condition>
            <Request/>
            <Response/>
        </Flow>
        <Flow name="AccountsById">
            <Description/>
            <Request>
                <Step>
                    <Name>KVMGetCredentials</Name>
                </Step>
                <Step>
                    <Name>CreateSOAPRequest</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>remove-namespaces</Name>
                </Step>
                <Step>
                    <Name>Remove-Empty-Nodes</Name>
                </Step>
                <Step>
                    <Name>ConvertSOAPToJSON</Name>
                </Step>
                <Step>
                    <Name>get-response-soap-body</Name>
                </Step>
                <Step>
                    <Name>constructJsonResponse</Name>
                </Step>
                <Step>
                    <Name>set-response-soap-body</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/account/*") and ((request.verb = "GET") or (request.verb = "POST"))</Condition>
        </Flow>
        <Flow name="clientsByAccountId">
            <Description/>
            <Request>
                <Step>
                    <Name>KVMGetCredentials</Name>
                </Step>
                <Step>
                    <Name>CreateSOAPRequest</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>remove-namespaces</Name>
                </Step>
                <Step>
                    <Name>Remove-Empty-Nodes</Name>
                </Step>
                <Step>
                    <Name>ConvertSOAPToJSON</Name>
                </Step>
                <Step>
                    <Name>get-response-soap-body</Name>
                </Step>
                <Step>
                    <Name>constructJsonResponse</Name>
                </Step>
                <Step>
                    <Name>set-response-soap-body</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/clients/*") and ((request.verb = "GET") or (request.verb = "POST"))</Condition>
        </Flow>
        <Flow name="producersByAccountId">
            <Description/>
            <Request>
                <Step>
                    <Name>KVMGetCredentials</Name>
                </Step>
                <Step>
                    <Name>CreateSOAPRequest</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>remove-namespaces</Name>
                </Step>
                <Step>
                    <Name>Remove-Empty-Nodes</Name>
                </Step>
                <Step>
                    <Name>ConvertSOAPToJSON</Name>
                </Step>
                <Step>
                    <Name>get-response-soap-body</Name>
                </Step>
                <Step>
                    <Name>constructJsonResponse</Name>
                </Step>
                <Step>
                    <Name>set-response-soap-body</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/producerInfo/*") and ((request.verb = "GET") or (request.verb = "POST"))</Condition>
        </Flow>
        <Flow name="FinancialsByAccountId">
            <Description/>
            <Request>
                <Step>
                    <Name>KVMGetCredentials</Name>
                </Step>
                <Step>
                    <Name>CreateSOAPRequest</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>remove-namespaces</Name>
                </Step>
                <Step>
                    <Name>Remove-Empty-Nodes</Name>
                </Step>
                <Step>
                    <Name>ConvertSOAPToJSON</Name>
                </Step>
                <Step>
                    <Name>get-response-soap-body</Name>
                </Step>
                <Step>
                    <Name>constructJsonResponse</Name>
                </Step>
                <Step>
                    <Name>set-response-soap-body</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/accountFinancialInfo/*") and ((request.verb = "GET") or (request.verb = "POST"))</Condition>
        </Flow>
        <Flow name="acctWarningsByAccountId">
            <Description/>
            <Request>
                <Step>
                    <Name>KVMGetCredentials</Name>
                </Step>
                <Step>
                    <Name>CreateSOAPRequest</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>remove-namespaces</Name>
                </Step>
                <Step>
                    <Name>Remove-Empty-Nodes</Name>
                </Step>
                <Step>
                    <Name>ConvertSOAPToJSON</Name>
                </Step>
                <Step>
                    <Name>get-response-soap-body</Name>
                </Step>
                <Step>
                    <Name>constructJsonResponse</Name>
                </Step>
                <Step>
                    <Name>set-response-soap-body</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/accountWarnings/*") and ((request.verb = "GET") or (request.verb = "POST"))</Condition>
        </Flow>
        <Flow name="acctAddtionalInfoByAccountId">
            <Description/>
            <Request>
                <Step>
                    <Name>KVMGetCredentials</Name>
                </Step>
                <Step>
                    <Name>CreateSOAPRequest</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>remove-namespaces</Name>
                </Step>
                <Step>
                    <Name>Remove-Empty-Nodes</Name>
                </Step>
                <Step>
                    <Name>ConvertSOAPToJSON</Name>
                </Step>
                <Step>
                    <Name>get-response-soap-body</Name>
                </Step>
                <Step>
                    <Name>constructJsonResponse</Name>
                </Step>
                <Step>
                    <Name>set-response-soap-body</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/accountAddtionalInfo/*") and ((request.verb = "GET") or (request.verb = "POST"))</Condition>
        </Flow>
        <Flow name="getaccountPolicies">
            <Description/>
            <Request>
                <Step>
                    <Name>KVMGetCredentials</Name>
                </Step>
                <Step>
                    <Name>CreateSOAPRequest</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>remove-namespaces</Name>
                </Step>
                <Step>
                    <Name>Remove-Empty-Nodes</Name>
                </Step>
                <Step>
                    <Name>ConvertSOAPToJSON</Name>
                </Step>
                <Step>
                    <Name>get-response-soap-body</Name>
                </Step>
                <Step>
                    <Name>constructJsonResponse</Name>
                </Step>
                <Step>
                    <Name>set-response-soap-body</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/policies/*") and ((request.verb = "GET") or (request.verb = "POST"))</Condition>
        </Flow>
        <Flow name="getaccountCounters">
            <Description/>
            <Request>
                <Step>
                    <Name>KVMGetCredentials</Name>
                </Step>
                <Step>
                    <Name>CreateSOAPRequest</Name>
                </Step>
            </Request>
            <Response>
                <Step>
                    <Name>remove-namespaces</Name>
                </Step>
                <Step>
                    <Name>Remove-Empty-Nodes</Name>
                </Step>
                <Step>
                    <Name>ConvertSOAPToJSON</Name>
                </Step>
                <Step>
                    <Name>get-response-soap-body</Name>
                </Step>
                <Step>
                    <Name>constructJsonResponse</Name>
                </Step>
                <Step>
                    <Name>set-response-soap-body</Name>
                </Step>
            </Response>
            <Condition>(proxy.pathsuffix MatchesPath "/counters/*") and ((request.verb = "GET") or (request.verb = "POST"))</Condition>
        </Flow>
    </Flows>
    <HTTPProxyConnection>
        <BasePath>/bam</BasePath>
        <Properties/>
        <VirtualHost>default</VirtualHost>
        <VirtualHost>secure</VirtualHost>
    </HTTPProxyConnection>
    <RouteRule name="default">
        <TargetEndpoint>default</TargetEndpoint>
        <Condition>(request.header.X-Enable-Nock==false)</Condition>
    </RouteRule>
    <RouteRule name="node">
        <TargetEndpoint>node</TargetEndpoint>
        <Condition>(request.header.X-Enable-Nock==true)</Condition>
    </RouteRule>
</ProxyEndpoint>